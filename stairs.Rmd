---
title: "Staircase and elevator use"
author: "Nandor Hajdu"
date: "2023-01-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE,
                      message = FALSE)
```

```{r read_data}
library(tidyverse)
library(tidymodels)
library(janitor)
library(glmertree)
library(here)
library(parameters)

# Set up parallel processing
doParallel::registerDoParallel(cores = parallelly::availableCores())

theme_set(theme_light())

```


```{r read_data}
stairs_raw <- read_csv(here("data/behav.csv"))

stairs <-
  stairs_raw %>%
  clean_names() %>%
  filter(building_visited != "EgyÃ©b:") %>%
  mutate(id = as.factor(id),
         choice = as.factor(choice)) %>%
  # filter IDs with less than 8 entries
  group_by(id) %>%
  add_count() %>%
  ungroup() %>%
  filter(n >= 8) %>% 
  select(-n)

```

## Split data into training and test sets

```{r}

set.seed(12)

stairs_split <- group_initial_split(stairs, group = id)
stairs_train <- training(stairs_split)
stairs_test <- testing(stairs_split)

```


## Specify tidymodels recipe of feature engineering

```{r glmertree_recipe}

stairs_rec <- 
  recipe(stairs_train, formula = choice ~ .) %>%
  step_impute_mode(peers) %>% 
  step_string2factor(all_nominal_predictors()) %>% 
  step_impute_knn(health) %>% 
  step_scale(all_numeric_predictors()) %>% 
  step_zv(all_predictors())
  
print(stairs_rec)

```

## Execute the recipe and prepare the data for analysis

```{r recipe_prep}
rec_prepped <- prep(stairs_rec)
stairs_train_baked <- bake(rec_prepped, new_data = NULL)

glimpse(stairs_train_baked)

```

## Model fitting

```{r model_fitting, cache=TRUE}
stairs_res <-
  glmertree(
    choice ~ 1 | id | laziness + fatigue + luggage +
      elevator_speed + environmental_consciousness +
      temperature + appeal +
      number_of_people_waiting_for_the_elevator + peers +
      measurement_no + health + building_visited + speed +
      destination_floor,
    family = "binomial",
    data = stairs_train_baked
  )

# write_rds(stairs_res, file = here("model/stairs_res.rds"))
# stairs_res <- read_rds(file = here("model/stairs_res.rds"))
```


# Investigating variable importance
```{r}
# Have to get variable importance


plot(stairs_res, which = "tree", type = "simple")
plot(stairs_res, which = "tree.coef")
stairs_res
```

## Checking accuracy on the test set

```{r accuracy_metrics}

stairs_test_baked <- bake(rec_prepped, new_data = stairs_test)

glmertree_pred <- 
  predict(
        stairs_res,
        newdata = stairs_test_baked,
        type = "response",
        allow.new.levels = TRUE
  )

predictions <- 
  tibble(
    truth = stairs_test_baked$choice,
    stairs_prob = 1 - glmertree_pred,
    elevator_prob = glmertree_pred,
    pred = as.factor(if_else(glmertree_pred > 0.5, 1, 0))
    )

predictions %>% 
  conf_mat(truth, pred) %>% 
  autoplot("heatmap")

accuracy_metrics <- 
  bind_rows(
    accuracy(predictions, truth = truth, estimate = pred),
    sensitivity(predictions, truth = truth, estimate = pred),
    specificity(predictions, truth = truth, estimate = pred),
    precision(predictions, truth = truth, estimate = pred),
    recall(predictions, truth = truth, estimate = pred),
    bal_accuracy(predictions, truth, pred),
    kap(predictions, truth = truth, estimate = pred),
    f_meas(predictions, truth, pred),
    roc_auc(predictions, truth, stairs_prob),
    pr_auc(predictions, truth, stairs_prob)
  ) %>% 
  mutate(.estimate = signif(.estimate, 3),
         .estimator = NULL
  )

accuracy_metrics

roc_curve(predictions, truth, stairs_prob) %>% autoplot()
pr_curve(predictions, truth, stairs_prob) %>% autoplot()


```
